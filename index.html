<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LIFE PATH — Character Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<style>
:root {
  --paper: #f4eed5;
  --paper-dark: #e8dfbe;
  --ink: #2a2118;
  --ink-light: #5a4d3a;
  --red: #8b2500;
  --red-light: #c0523a;
  --blue: #1a3a5c;
  --green: #2d5016;
  --gold: #b8860b;
  --typewriter: 'Special Elite', 'Courier New', monospace;
  --body: 'Courier Prime', 'Courier New', monospace;
  --display: 'Playfair Display', Georgia, serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #1a1510;
  color: var(--ink);
  font-family: var(--body);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.grain-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  z-index: 9999;
  opacity: 0.03;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

header {
  width: 100%;
  padding: 40px 20px 30px;
  text-align: center;
  background: linear-gradient(180deg, #2a2118 0%, #1a1510 100%);
  border-bottom: 3px double var(--gold);
  position: relative;
}

header::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 1px;
  background: var(--gold);
  opacity: 0.4;
}

header h1 {
  font-family: var(--display);
  font-size: clamp(2.5rem, 6vw, 4.5rem);
  color: var(--paper);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  font-weight: 900;
  text-shadow: 2px 2px 0 rgba(184,134,11,0.3);
}

header .subtitle {
  font-family: var(--typewriter);
  color: var(--gold);
  font-size: 0.95rem;
  letter-spacing: 0.3em;
  margin-top: 8px;
  text-transform: uppercase;
}

.controls {
  display: flex;
  gap: 16px;
  justify-content: center;
  padding: 30px 20px;
  flex-wrap: wrap;
}

button {
  font-family: var(--typewriter);
  font-size: 1rem;
  padding: 12px 32px;
  border: 2px solid var(--gold);
  background: #2a2118;
  color: var(--paper);
  cursor: pointer;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  transition: all 0.3s;
  position: relative;
}

button:hover {
  background: var(--gold);
  color: #1a1510;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(184,134,11,0.3);
}

button.gender-btn {
  min-width: 120px;
}

button.gender-btn.active {
  background: var(--gold);
  color: #1a1510;
}

button.generate {
  border-color: var(--red);
  font-size: 1.1rem;
  padding: 14px 48px;
}

button.generate:hover {
  background: var(--red);
  border-color: var(--red);
}

.dossier {
  width: 100%;
  max-width: 820px;
  margin: 0 auto 60px;
  padding: 0 20px;
}

.page {
  background: var(--paper);
  padding: 50px 50px 40px;
  margin-bottom: 24px;
  position: relative;
  box-shadow: 4px 4px 20px rgba(0,0,0,0.5), inset 0 0 60px rgba(0,0,0,0.04);
  border: 1px solid rgba(0,0,0,0.1);
}

.page::before {
  content: '';
  position: absolute;
  top: 0; left: 50px; right: 50px; bottom: 0;
  background: repeating-linear-gradient(transparent, transparent 27px, #c9b99a33 27px, #c9b99a33 28px);
  pointer-events: none;
}

.page-header {
  font-family: var(--display);
  font-size: 1.6rem;
  color: var(--red);
  border-bottom: 2px solid var(--red);
  padding-bottom: 8px;
  margin-bottom: 20px;
  font-weight: 700;
  position: relative;
  z-index: 1;
}

.page-header .era {
  float: right;
  font-family: var(--typewriter);
  font-size: 0.85rem;
  color: var(--ink-light);
  font-weight: 400;
}

.stat-block {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 30px;
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
}

.stat {
  font-size: 0.9rem;
  line-height: 1.6;
}

.stat .label {
  font-weight: 700;
  color: var(--blue);
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
}

.narrative {
  position: relative;
  z-index: 1;
  font-size: 0.92rem;
  line-height: 1.85;
  text-align: justify;
  margin-bottom: 16px;
  text-indent: 2em;
}

.narrative:first-of-type {
  text-indent: 0;
}

.event-block {
  position: relative;
  z-index: 1;
  margin: 16px 0;
  padding: 12px 16px;
  border-left: 3px solid var(--gold);
  background: rgba(184,134,11,0.06);
}

.event-block.negative {
  border-left-color: var(--red);
  background: rgba(139,37,0,0.05);
}

.event-block.positive {
  border-left-color: var(--green);
  background: rgba(45,80,22,0.05);
}

.event-block .event-year {
  font-family: var(--typewriter);
  font-size: 0.8rem;
  color: var(--ink-light);
  font-weight: 700;
}

.event-block .event-text {
  font-size: 0.88rem;
  line-height: 1.7;
  margin-top: 4px;
}

.stamp {
  position: absolute;
  top: 20px;
  right: 30px;
  font-family: var(--display);
  font-size: 1.1rem;
  color: var(--red);
  border: 3px solid var(--red);
  padding: 6px 16px;
  transform: rotate(4deg);
  opacity: 0.7;
  z-index: 2;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 900;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin: 20px 0;
  position: relative;
  z-index: 1;
}

.summary-card {
  text-align: center;
  padding: 16px;
  border: 1px solid var(--ink-light);
}

.summary-card .card-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-light);
  margin-bottom: 4px;
}

.summary-card .card-value {
  font-family: var(--display);
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--blue);
}

.trait-list {
  position: relative;
  z-index: 1;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 12px 0;
}

.trait-tag {
  font-family: var(--typewriter);
  font-size: 0.78rem;
  padding: 4px 12px;
  border: 1px solid var(--ink-light);
  background: rgba(0,0,0,0.03);
}

.trait-tag.positive { border-color: var(--green); color: var(--green); }
.trait-tag.negative { border-color: var(--red); color: var(--red); }
.trait-tag.neutral { border-color: var(--blue); color: var(--blue); }

.mj-prompt-box {
  position: relative;
  z-index: 1;
  background: #1a1510;
  color: #c8bfa8;
  font-family: 'Courier Prime', monospace;
  font-size: 0.85rem;
  line-height: 1.7;
  padding: 24px;
  border: 1px solid var(--gold);
  margin: 16px 0;
  white-space: pre-wrap;
  word-break: break-word;
  cursor: text;
  user-select: all;
}

.mj-prompt-box::before {
  content: '/imagine prompt: ';
  color: var(--gold);
  font-weight: 700;
}

.copy-btn {
  position: relative;
  z-index: 1;
  display: inline-block;
  margin: 6px 4px;
  font-family: var(--typewriter);
  font-size: 0.82rem;
  padding: 9px 22px;
  border: 1px solid var(--gold);
  background: transparent;
  color: var(--gold);
  cursor: pointer;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  transition: all 0.3s;
}

.copy-btn:hover {
  background: var(--gold);
  color: #1a1510;
  transform: translateY(-1px);
}

.copy-btn.copied {
  background: var(--green);
  border-color: var(--green);
  color: var(--paper);
}

.mj-note {
  position: relative;
  z-index: 1;
  font-size: 0.75rem;
  color: var(--ink-light);
  text-align: center;
  margin-top: 10px;
  font-style: italic;
}

.portrait-controls {
  position: relative;
  z-index: 1;
  margin: 20px 0 12px;
}

.style-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}

.style-btn {
  font-family: var(--typewriter);
  font-size: 0.78rem;
  padding: 8px 18px;
  border: 1px solid var(--ink-light);
  background: transparent;
  color: var(--ink);
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: all 0.25s;
  position: relative;
}

.style-btn:hover {
  border-color: var(--gold);
  color: var(--gold);
  transform: translateY(-1px);
}

.style-btn.active {
  background: var(--ink);
  color: var(--paper);
  border-color: var(--ink);
}

.style-btn .style-sub {
  display: block;
  font-size: 0.6rem;
  opacity: 0.6;
  margin-top: 2px;
  text-transform: none;
  letter-spacing: 0;
}

.custom-desc-area {
  position: relative;
  z-index: 1;
  margin: 16px 0;
}

.custom-desc-toggle {
  font-family: var(--typewriter);
  font-size: 0.78rem;
  color: var(--blue);
  cursor: pointer;
  border: none;
  background: none;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 4px 0;
  border-bottom: 1px dashed var(--blue);
  transition: color 0.2s;
}

.custom-desc-toggle:hover {
  color: var(--gold);
  border-color: var(--gold);
}

.custom-desc-panel {
  display: none;
  margin-top: 12px;
}

.custom-desc-panel.open {
  display: block;
  animation: fadeIn 0.3s ease;
}

.custom-desc-panel label {
  font-family: var(--typewriter);
  font-size: 0.75rem;
  color: var(--ink-light);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  display: block;
  margin-bottom: 6px;
}

.custom-desc-panel textarea {
  width: 100%;
  font-family: var(--body);
  font-size: 0.88rem;
  padding: 12px;
  border: 1px solid var(--ink-light);
  background: var(--paper-dark);
  color: var(--ink);
  resize: vertical;
  min-height: 60px;
  line-height: 1.5;
}

.custom-desc-panel textarea:focus {
  outline: none;
  border-color: var(--gold);
}

.custom-desc-panel .desc-hint {
  font-size: 0.7rem;
  color: var(--ink-light);
  font-style: italic;
  margin-top: 4px;
}

.prompt-actions {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  position: relative;
  z-index: 1;
  margin-top: 8px;
}

#output { display: none; }
#output.visible { display: block; animation: fadeIn 0.5s ease; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.loading {
  text-align: center;
  padding: 60px;
  color: var(--paper);
  font-family: var(--typewriter);
  font-size: 1.1rem;
  letter-spacing: 0.1em;
  display: none;
}

.loading.visible { display: block; }

.loading .dots::after {
  content: '';
  animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
  0% { content: ''; }
  25% { content: '.'; }
  50% { content: '..'; }
  75% { content: '...'; }
}

.section-divider {
  text-align: center;
  margin: 12px 0;
  position: relative;
  z-index: 1;
  color: var(--ink-light);
  font-size: 0.8rem;
  letter-spacing: 0.3em;
}

.export-bar {
  display: none;
  gap: 12px;
  justify-content: center;
  padding: 10px 20px 30px;
  flex-wrap: wrap;
}

.export-bar.visible { display: flex; }

button.export-btn {
  font-size: 0.85rem;
  padding: 10px 24px;
  border: 1px solid var(--gold);
  background: transparent;
  color: var(--gold);
  min-width: 180px;
}

button.export-btn:hover {
  background: var(--gold);
  color: #1a1510;
}

button.export-btn .btn-sub {
  display: block;
  font-size: 0.65rem;
  opacity: 0.7;
  margin-top: 2px;
  letter-spacing: 0.05em;
}

@media (max-width: 600px) {
  .page { padding: 30px 24px; }
  .stat-block { grid-template-columns: 1fr; }
  .summary-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>
<div class="grain-overlay"></div>

<header>
  <h1>Life Path</h1>
  <div class="subtitle">Character Dossier Generator · 1949–1982</div>
</header>

<div class="controls">
  <button class="gender-btn active" id="btn-random" onclick="setGender('random')">Random</button>
  <button class="gender-btn" id="btn-male" onclick="setGender('male')">Male</button>
  <button class="gender-btn" id="btn-female" onclick="setGender('female')">Female</button>
  <button class="generate" onclick="generate()">Generate Life Path</button>
</div>

<div class="export-bar" id="export-bar">
  <button class="export-btn" onclick="exportRoll20HTML()">
    Download for Roll20
    <span class="btn-sub">HTML — paste into Bio &amp; Info</span>
  </button>
  <button class="export-btn" onclick="exportPlainText()">
    Download Text File
    <span class="btn-sub">Plain text — universal</span>
  </button>
  <button class="export-btn" onclick="exportJSON()">
    Download JSON
    <span class="btn-sub">Structured data — import/API</span>
  </button>
</div>

<div class="loading" id="loading">
  Generating life path<span class="dots"></span>
</div>

<div class="dossier" id="output"></div>

<script>
let chosenGender = 'random';

function setGender(g) {
  chosenGender = g;
  document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + g).classList.add('active');
}

// ─── UTILITY ───
function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function roll(n) { return Math.floor(Math.random() * n) + 1; }
function rollRange(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function chance(pct) { return Math.random() * 100 < pct; }
function weightedPick(arr) {
  const total = arr.reduce((s, i) => s + i.w, 0);
  let r = Math.random() * total;
  for (const item of arr) { r -= item.w; if (r <= 0) return item.v; }
  return arr[arr.length - 1].v;
}

// ─── DATA TABLES ───
const DATA = {
  maleFirst: ["James","Robert","John","Michael","David","William","Richard","Thomas","Charles","Daniel","Steven","Kenneth","Mark","Paul","Donald","Kevin","Brian","Timothy","Ronald","Edward","Anthony","Jeffrey","Gary","Scott","Frank","Raymond","Patrick","Dennis","Jerry","Terry","Lawrence","Keith","Randy","Barry","Eugene","Craig","Alan","Bruce","Gerald","Wayne","Russell","Philip","Douglas","Nathan","Dale","Vincent","Curtis","Jesse","Troy","Darren","Todd","Joel","Rodney","Rick","Glenn","Martin","Clifford","Leroy","Hector","Benjamin","Clayton","Duane","Earl","Lester","Warren","Mitchell","Wesley","Lonnie","Melvin","Vernon","Alvin","Virgil","Grady"],
  femaleFirst: ["Mary","Patricia","Linda","Barbara","Elizabeth","Jennifer","Maria","Susan","Margaret","Dorothy","Lisa","Nancy","Karen","Betty","Helen","Sandra","Donna","Carol","Ruth","Sharon","Michelle","Laura","Sarah","Kimberly","Deborah","Jessica","Shirley","Cynthia","Angela","Melissa","Brenda","Amy","Anna","Rebecca","Virginia","Kathleen","Pamela","Martha","Debra","Amanda","Stephanie","Carolyn","Christine","Janet","Catherine","Frances","Ann","Joyce","Diane","Alice","Julie","Heather","Teresa","Gloria","Evelyn","Cheryl","Mildred","Bonnie","Tanya","Lorraine","Tammy","Crystal","Wanda","Gail","Connie","Darlene","Patsy","Yvonne","Jolene","Nadine"],
  last: ["Smith","Johnson","Williams","Brown","Jones","Garcia","Miller","Davis","Rodriguez","Martinez","Anderson","Taylor","Thomas","Moore","Jackson","Martin","Lee","Thompson","White","Harris","Clark","Lewis","Robinson","Walker","Hall","Allen","Young","King","Wright","Scott","Hill","Green","Adams","Baker","Nelson","Carter","Mitchell","Roberts","Turner","Phillips","Campbell","Parker","Evans","Edwards","Collins","Stewart","Morris","Murphy","Rivera","Rogers","Reed","Cooper","Ward","Cox","Howard","Brooks","Bennett","Gray","Wood","Barnes","Ross","Henderson","Coleman","Jenkins","Perry","Butler","Foster","Simmons","Gonzalez","Bryant","Russell","Griffin","Hayes","Dixon","Owens","Fisher","Webb","Simpson","Stevens","Tucker","Porter","Hicks","Crawford","Boyd","Mason","Warren","Snyder","Hoffman","Keller","Dunn","Burns","Garrett","Watts","Palmer","Flynn","Caldwell","Nash","Harmon","Kirby","Whitaker","Dalton","Pruitt","Ratliff","Mackey"],
  cities: [
    {name:"Detroit, Michigan",type:"industrial"},{name:"Newark, New Jersey",type:"urban"},{name:"Chicago, Illinois",type:"urban"},
    {name:"Los Angeles, California",type:"urban"},{name:"Houston, Texas",type:"southern"},{name:"Atlanta, Georgia",type:"southern"},
    {name:"Boston, Massachusetts",type:"urban"},{name:"Philadelphia, Pennsylvania",type:"urban"},{name:"San Francisco, California",type:"urban"},
    {name:"Denver, Colorado",type:"western"},{name:"Seattle, Washington",type:"western"},{name:"Portland, Oregon",type:"western"},
    {name:"Nashville, Tennessee",type:"southern"},{name:"Dallas, Texas",type:"southern"},{name:"Phoenix, Arizona",type:"western"},
    {name:"Milwaukee, Wisconsin",type:"industrial"},{name:"Pittsburgh, Pennsylvania",type:"industrial"},{name:"Baltimore, Maryland",type:"urban"},
    {name:"St. Louis, Missouri",type:"industrial"},{name:"New Orleans, Louisiana",type:"southern"},
    {name:"Cleveland, Ohio",type:"industrial"},{name:"Minneapolis, Minnesota",type:"industrial"},
    {name:"Kansas City, Missouri",type:"industrial"},{name:"Tampa, Florida",type:"southern"},
    {name:"small town in rural Kentucky",type:"rural"},{name:"small town in rural Montana",type:"rural"},
    {name:"small town in upstate New York",type:"rural"},{name:"small town in rural Nebraska",type:"rural"},
    {name:"small town in west Texas",type:"rural"},{name:"small town in the Ozarks",type:"rural"},
    {name:"small town in rural Georgia",type:"rural"},{name:"small town in Appalachian Virginia",type:"rural"},
    {name:"small town in the Mississippi Delta",type:"rural"},{name:"Anchorage, Alaska",type:"western"},
    {name:"Honolulu, Hawaii",type:"western"},{name:"a trailer park outside Tulsa, Oklahoma",type:"rural"},
    {name:"the suburbs of Long Island, New York",type:"suburban"},{name:"a suburb of Minneapolis",type:"suburban"},
    {name:"a working-class neighborhood in Cincinnati, Ohio",type:"industrial"},
    {name:"the outskirts of Albuquerque, New Mexico",type:"western"},
    {name:"a military base in San Diego, California",type:"military"},
    {name:"a military base in Fort Bragg, North Carolina",type:"military"}
  ],
  dadJobs: [
    {job:"factory worker",class:"lower"},{job:"mechanic",class:"lower"},{job:"truck driver",class:"lower"},
    {job:"construction worker",class:"lower"},{job:"janitor",class:"lower"},{job:"warehouse worker",class:"lower"},
    {job:"gas station attendant",class:"lower"},{job:"butcher",class:"lower"},
    {job:"carpenter",class:"working"},{job:"electrician",class:"working"},{job:"plumber",class:"working"},
    {job:"police officer",class:"working"},{job:"firefighter",class:"working"},{job:"postal worker",class:"working"},
    {job:"bus driver",class:"working"},{job:"auto body repairman",class:"working"},{job:"machinist",class:"working"},
    {job:"welder",class:"working"},{job:"longshoreman",class:"working"},{job:"steelworker",class:"working"},
    {job:"coal miner",class:"working"},{job:"mill worker",class:"working"},
    {job:"insurance salesman",class:"middle"},{job:"bank teller",class:"middle"},{job:"schoolteacher",class:"middle"},
    {job:"accountant",class:"middle"},{job:"small business owner",class:"middle"},{job:"manager at a department store",class:"middle"},
    {job:"real estate agent",class:"middle"},{job:"car salesman",class:"middle"},{job:"pharmacist",class:"middle"},
    {job:"engineer",class:"upper-middle"},{job:"lawyer",class:"upper-middle"},{job:"doctor",class:"upper-middle"},
    {job:"professor",class:"upper-middle"},{job:"architect",class:"upper-middle"},
    {job:"career Army NCO",class:"working"},{job:"Navy enlisted man",class:"working"},{job:"Air Force officer",class:"upper-middle"},
    {job:"unemployed",class:"poverty"},{job:"disabled veteran",class:"poverty"},{job:"drifter",class:"poverty"},
    {job:"preacher",class:"working"},{job:"farmer",class:"working"},{job:"rancher",class:"working"},
    {job:"fisherman",class:"working"},{job:"bartender",class:"lower"},{job:"cab driver",class:"lower"},
    {job:"musician",class:"lower"},{job:"small-time crook",class:"poverty"}
  ],
  momJobs: [
    {job:"homemaker",class:"any"},{job:"homemaker",class:"any"},{job:"homemaker",class:"any"},
    {job:"waitress",class:"lower"},{job:"secretary",class:"working"},{job:"nurse",class:"working"},
    {job:"schoolteacher",class:"middle"},{job:"cashier",class:"lower"},{job:"receptionist",class:"working"},
    {job:"hairdresser",class:"working"},{job:"telephone operator",class:"working"},{job:"librarian",class:"middle"},
    {job:"seamstress",class:"lower"},{job:"cleaning lady",class:"lower"},{job:"diner cook",class:"lower"},
    {job:"office clerk",class:"working"},{job:"dental hygienist",class:"working"},{job:"bank teller",class:"working"},
    {job:"social worker",class:"middle"},{job:"factory line worker",class:"lower"},
    {job:"absent — left the family",class:"absent"},{job:"deceased",class:"absent"}
  ],
  ethnicities: [
    {v:"White (Anglo-Saxon)",w:55},{v:"White (Irish-American)",w:8},{v:"White (Italian-American)",w:6},
    {v:"White (Polish-American)",w:4},{v:"Black (African-American)",w:12},{v:"Hispanic (Mexican-American)",w:7},
    {v:"Hispanic (Puerto Rican)",w:3},{v:"Asian (Chinese-American)",w:2},{v:"Asian (Japanese-American)",w:1},
    {v:"Native American",w:1},{v:"White (Jewish-American)",w:3},{v:"Mixed Race",w:2}
  ],
  religions: [
    {v:"Protestant (Baptist)",w:20},{v:"Protestant (Methodist)",w:12},{v:"Catholic",w:25},
    {v:"Protestant (Lutheran)",w:8},{v:"Protestant (Pentecostal)",w:6},{v:"Jewish",w:4},
    {v:"Non-religious",w:10},{v:"Protestant (Episcopalian)",w:5},{v:"Mormon",w:3},
    {v:"Evangelical",w:5},{v:"Jehovah's Witness",w:1},{v:"Buddhist",w:1}
  ],
  personalityTraits: {
    positive: ["kind","brave","curious","resourceful","charismatic","loyal","creative","determined","empathetic","witty","patient","generous","optimistic","adaptable","disciplined","honest","perceptive","charming","resilient","ambitious"],
    negative: ["hot-tempered","anxious","stubborn","impulsive","jealous","secretive","cynical","reckless","manipulative","lazy","arrogant","distrustful","obsessive","vindictive","self-destructive","cowardly","vain","dishonest","cold","resentful"],
    neutral: ["introverted","extroverted","quiet","intense","dreamy","practical","sarcastic","blunt","sensitive","cautious","competitive","independent","sentimental","restless","old-fashioned","eccentric","stoic","passionate","analytical","rebellious"]
  },
  childhoodHobbies: ["reading comic books","playing baseball","exploring the woods","riding bikes","building model cars","watching TV","playing with action figures","climbing trees","fishing at the creek","playing tag","skateboarding","collecting baseball cards","playing football in the yard","swimming at the public pool","catching fireflies","playing army","riding horses","drawing","playing piano","singing in the church choir","tinkering with electronics","playing basketball","roller skating","building forts","playing Dungeons & Dragons","listening to records","playing with dolls","jump rope","gymnastics","ballet","playing house","reading Nancy Drew","collecting stickers","horseback riding"],
  teenHobbies: ["working on cars","playing in a garage band","going to concerts","cruising main street","hanging out at the arcade","smoking behind the bleachers","going to drive-in movies","listening to records alone","playing sports","reading voraciously","writing poetry","drawing and painting","taking photographs","working a part-time job","volunteering","going to parties","dating","skateboarding","surfing","hiking and camping","playing Dungeons & Dragons","ham radio","fixing motorcycles","attending protests","hunting and fishing","weight lifting","martial arts","drama club","debate team","chess club"],
  musicTastes: ["Led Zeppelin","Black Sabbath","Fleetwood Mac","The Eagles","Lynyrd Skynyrd","Pink Floyd","The Bee Gees","ABBA","Donna Summer","Stevie Wonder","Earth, Wind & Fire","The Clash","The Ramones","Blondie","David Bowie","AC/DC","Van Halen","Rush","Boston","Aerosmith","The Rolling Stones","Creedence Clearwater Revival","The Allman Brothers","Hank Williams Jr.","Willie Nelson","Johnny Cash","Bob Marley","Funkadelic","Curtis Mayfield","Joy Division","Talking Heads","Devo"],
  fears: ["the dark","being alone","failure","their father","their mother","loud noises","abandonment","poverty","dogs","heights","water","small spaces","public speaking","being forgotten","nuclear war","being ordinary","authority","intimacy","death","losing control"],
};

// ─── GENERATION ENGINE ───
function generateCharacter() {
  const C = {};

  // BIRTH
  C.birthYear = rollRange(1949, 1957);
  C.gender = chosenGender === 'random' ? pick(['male','female']) : chosenGender;
  C.firstName = pick(C.gender === 'male' ? DATA.maleFirst : DATA.femaleFirst);
  C.lastName = pick(DATA.last);
  C.fullName = C.firstName + " " + C.lastName;
  C.birthCity = pick(DATA.cities);
  C.ethnicity = weightedPick(DATA.ethnicities);
  C.religion = weightedPick(DATA.religions);

  // PARENTS
  C.dadFirst = pick(DATA.maleFirst);
  C.momFirst = pick(DATA.femaleFirst);
  C.momMaiden = pick(DATA.last);
  C.dadJob = pick(DATA.dadJobs);
  C.momJob = pick(DATA.momJobs);

  // Family class derived from dad's job primarily
  const classMap = {'poverty':1,'lower':2,'working':3,'middle':4,'upper-middle':5};
  C.familyClass = C.dadJob.class;
  C.classLevel = classMap[C.familyClass] || 3;

  // Family structure
  C.siblings = weightedPick([{v:0,w:15},{v:1,w:25},{v:2,w:25},{v:3,w:15},{v:4,w:10},{v:5,w:5},{v:6,w:3},{v:7,w:2}]);
  C.birthOrder = C.siblings === 0 ? "only child" : pick(["oldest","middle","youngest","second oldest","second youngest"]);
  if (C.siblings <= 1 && C.birthOrder === "middle") C.birthOrder = C.siblings === 0 ? "only child" : pick(["older","younger"]);

  // Birth complications
  C.birthEvent = weightedPick([
    {v:"normal",w:60},{v:"premature",w:8},{v:"difficult delivery",w:10},{v:"born during a storm",w:5},
    {v:"born on a holiday",w:5},{v:"twins (the other didn't survive)",w:2},{v:"born in a car on the way to the hospital",w:3},
    {v:"born at home — couldn't make it to the hospital",w:4},{v:"cord wrapped around neck but survived",w:3}
  ]);

  // Parent relationship
  C.parentRelationship = weightedPick([
    {v:"loving and stable",w:25},{v:"functional but distant",w:20},{v:"volatile — lots of arguing",w:15},
    {v:"father was emotionally absent",w:10},{v:"mother was overbearing",w:5},{v:"divorced by age 5",w:8},
    {v:"divorced during teen years",w:7},{v:"father was an alcoholic",w:8},{v:"both parents were addicts",w:2},
    {v:"father was physically abusive",w:5},{v:"extremely religious household",w:5},
    {v:"father died young",w:4},{v:"mother died young",w:3},{v:"raised mostly by grandparents",w:4},
    {v:"loving but very poor",w:6},{v:"cold and authoritarian",w:5},{v:"father in prison",w:3},
    {v:"parents separated — moved between households",w:4}
  ]);

  // DAD personality
  C.dadPersonality = weightedPick([
    {v:"stern but fair",w:15},{v:"warm and supportive",w:15},{v:"cold and distant",w:12},
    {v:"violent when drinking",w:8},{v:"a dreamer who never followed through",w:7},
    {v:"hardworking and proud",w:15},{v:"lazy and resentful",w:5},{v:"funny and charming but unreliable",w:8},
    {v:"a quiet, stoic man",w:10},{v:"extremely strict",w:8},{v:"absent most of the time",w:7}
  ]);

  // MOM personality
  C.momPersonality = weightedPick([
    {v:"warm and nurturing",w:20},{v:"anxious and overprotective",w:12},{v:"tough as nails",w:10},
    {v:"gentle but sad",w:8},{v:"fiercely independent",w:7},{v:"deeply religious",w:8},
    {v:"sharp-tongued and critical",w:8},{v:"quiet and submissive",w:7},{v:"the backbone of the family",w:12},
    {v:"emotionally unavailable",w:5},{v:"loving but exhausted",w:10}
  ]);

  // CHILDHOOD (ages 0-12)
  C.childhoodEvents = [];
  const addChildEvent = (year, text, type) => C.childhoodEvents.push({year, text, type});

  // Early childhood (0-5)
  if (chance(20)) addChildEvent(C.birthYear + rollRange(1,3), pick([
    "Was hospitalized for a serious illness.",
    "Family moved to a new city after dad lost his job.",
    "A beloved pet died tragically.",
    "Was involved in a car accident — minor injuries but lasting fear.",
    "Parents had a new baby — felt displaced.",
    "Was left with a relative for an extended period.",
    "Experienced a house fire — family lost most possessions."
  ]), "negative");

  if (chance(30)) addChildEvent(C.birthYear + rollRange(2,5), pick([
    "Learned to read before kindergarten — showed early promise.",
    "Made a best friend in the neighborhood who would become a lifelong companion.",
    "Won a local talent show.",
    "Family got their first color TV.",
    "Dad taught them to ride a bike — a cherished memory.",
    "Grandparents took them on a special trip.",
    "Family adopted a dog that became their constant companion."
  ]), "positive");

  // Elementary school (6-12)
  C.elementaryExperience = weightedPick([
    {v:"was a good student who enjoyed school",w:20},
    {v:"struggled academically but was popular",w:15},
    {v:"was bullied relentlessly",w:10},
    {v:"was the class clown",w:10},
    {v:"was a quiet, invisible kid",w:12},
    {v:"was a natural leader among peers",w:8},
    {v:"was a troublemaker who spent time in the principal's office",w:10},
    {v:"was a bookworm who preferred the library",w:10},
    {v:"was an athlete even at a young age",w:8},
    {v:"bounced between schools due to family instability",w:7}
  ]);

  // Childhood events (6-12)
  for (let i = 0; i < rollRange(2,5); i++) {
    const yr = C.birthYear + rollRange(6, 12);
    if (chance(50)) {
      addChildEvent(yr, pick([
        "Was caught shoplifting from a corner store.",
        "Broke an arm falling out of a tree.",
        "A close family member passed away.",
        "Parents went through a rough financial patch — utilities got cut off.",
        "Got into a serious fight at school and was suspended.",
        "Was caught in a lie that damaged a friendship.",
        "Witnessed something traumatic in the neighborhood.",
        "Was molested by a trusted adult — never told anyone.",
        "Failed a grade and had to repeat it.",
        "Family was evicted and had to move suddenly.",
        "Was bitten by a dog — left a scar and a phobia.",
        "Best friend moved away and they lost touch.",
        "A teacher humiliated them in front of the class.",
        "Found out a family secret that changed everything.",
        "Parents split up — had to choose who to live with.",
        "Started wetting the bed again from stress.",
        "Saw their parent get arrested.",
        "Neighborhood was hit by a natural disaster."
      ]), "negative");
    } else {
      addChildEvent(yr, pick([
        "Won a school spelling bee.",
        "Discovered a passion for " + pick(DATA.childhoodHobbies) + ".",
        "A teacher took special interest and became a mentor.",
        "Family took a road trip vacation — first time seeing the ocean.",
        "Made the Little League team and became a star player.",
        "Performed in the school play and got a standing ovation.",
        "Saved up allowance and bought something special.",
        "Helped a stranger and was praised by the whole family.",
        "Found a secret hideout that became a personal sanctuary.",
        "Won a prize at the county fair.",
        "Got a paper route and learned the value of hard work.",
        "A new kid moved to the neighborhood and became a close friend.",
        "Learned to cook from a grandparent — a lasting bond.",
        "Family celebrated a special milestone together.",
        "Was given a meaningful gift that they still treasure.",
        "Stood up to a bully and earned respect."
      ]), "positive");
    }
  }

  // Childhood hobby
  const genderHobbies = C.gender === 'male' ? DATA.childhoodHobbies.slice(0, 22) : DATA.childhoodHobbies;
  C.childhoodHobby = pick(genderHobbies);

  // Childhood personality
  C.childhoodTraits = [
    pick(DATA.personalityTraits.positive),
    pick(DATA.personalityTraits.neutral),
    chance(40) ? pick(DATA.personalityTraits.negative) : pick(DATA.personalityTraits.neutral)
  ];

  C.childhoodFear = pick(DATA.fears);
  C.childhoodDream = pick([
    "wanted to be an astronaut","wanted to be a cowboy","wanted to be a firefighter","wanted to be a rock star",
    "wanted to be a professional athlete","wanted to be a movie star","wanted to be a soldier","wanted to be a pilot",
    "wanted to be a detective","wanted to run away and join the circus","wanted to be a veterinarian",
    "wanted to be a doctor","wanted to be president","wanted to be a race car driver","wanted to be an artist",
    "wanted to be a scientist","dreamed of escaping their small town","dreamed of being rich and famous",
    "wanted to be a teacher like their favorite teacher","wanted to be a police officer"
  ]);

  // ─── TEEN YEARS (13-17) ───
  C.teenEvents = [];
  const addTeenEvent = (year, text, type) => C.teenEvents.push({year, text, type});

  C.highSchoolType = weightedPick([
    {v:"public high school",w:65},{v:"Catholic high school",w:15},{v:"private prep school",w:5},
    {v:"vocational high school",w:10},{v:"alternative school",w:3},{v:"military academy",w:2}
  ]);

  C.teenAcademics = weightedPick([
    {v:"honor roll student",w:12},{v:"average student",w:30},{v:"below average — barely scraping by",w:18},
    {v:"gifted but lazy",w:10},{v:"dedicated and studious",w:8},{v:"dropped out",w:8},
    {v:"class valedictorian",w:3},{v:"special education",w:4},{v:"frequently truant",w:7}
  ]);

  C.teenSocial = weightedPick([
    {v:"popular kid",w:10},{v:"part of the jock crowd",w:10},{v:"a nerd or geek",w:10},
    {v:"a loner",w:12},{v:"a burnout/stoner",w:8},{v:"a punk or rebel",w:7},
    {v:"part of the drama/art crowd",w:8},{v:"a drifter between groups",w:10},
    {v:"the tough kid nobody messed with",w:8},{v:"the class clown",w:7},
    {v:"the quiet one nobody noticed",w:10},{v:"the preacher's kid rebelling hard",w:3}
  ]);

  C.teenHobby = pick(DATA.teenHobbies);
  C.musicTaste = pick(DATA.musicTastes);

  // First love
  C.firstLove = weightedPick([
    {v:"had a sweet but brief first love",w:20},
    {v:"fell hard for someone who didn't feel the same way",w:15},
    {v:"had a passionate but turbulent teenage romance",w:12},
    {v:"never really dated — too shy or too focused",w:15},
    {v:"had a secret relationship their parents wouldn't approve of",w:10},
    {v:"dated the most popular kid in school",w:5},
    {v:"got their heart broken badly and built walls",w:12},
    {v:"had a summer fling that changed them",w:8},
    {v:"got someone pregnant / got pregnant — it changed everything",w:5},
    {v:"was in an abusive relationship",w:4},
    {v:"realized they were attracted to the same sex — kept it hidden",w:4}
  ]);

  // Teen events
  for (let i = 0; i < rollRange(3, 6); i++) {
    const yr = C.birthYear + rollRange(13, 17);
    if (chance(45)) {
      addTeenEvent(yr, pick([
        "Got arrested for the first time — " + pick(["shoplifting","vandalism","underage drinking","trespassing","fighting","joyriding","drug possession"]) + ".",
        "Was in a car accident that left lasting scars.",
        "A close friend died — " + pick(["car crash","overdose","suicide","drowning","violence"]) + ".",
        "Developed a drinking problem.",
        "Started using drugs — " + pick(["marijuana","acid","quaaludes","cocaine","PCP","speed"]) + ".",
        "Was expelled from school.",
        "Ran away from home for " + pick(["a weekend","a week","a month","several months"]) + ".",
        "Was assaulted and never reported it.",
        "Parents finalized their divorce — messy custody battle.",
        "A parent was diagnosed with a serious illness.",
        "Was involved in a gang or crew that brought trouble.",
        "Got into a fight that resulted in serious injury.",
        "Failed multiple classes and was held back.",
        "Was betrayed by their best friend.",
        "Caught their parent having an affair.",
        "Was homeless for a period — slept in cars and couches.",
        "Witnessed a violent crime.",
        "Attempted suicide — survived but carried the weight."
      ]), "negative");
    } else {
      addTeenEvent(yr, pick([
        "Got their first car — a beat-up " + pick(["'67 Mustang","'72 Pinto","'69 Camaro","'74 Nova","'71 Beetle","'65 Impala","'70 Duster","'73 Maverick","'68 Charger","'76 Trans Am"]) + ".",
        "Won a state championship in " + pick(["football","basketball","track","wrestling","baseball","swimming","debate","drama"]) + ".",
        "Got a job at " + pick(["a gas station","a diner","a grocery store","a movie theater","a car wash","a fast food joint","a record store","a mechanic's shop"]) + " and gained independence.",
        "Discovered a talent for " + pick(["writing","art","music","mechanics","cooking","public speaking","computers","photography"]) + ".",
        "Found a mentor — " + pick(["a teacher","a coach","a neighbor","a boss","an older friend","a relative"]) + " who believed in them.",
        "Had an experience that shaped their worldview — " + pick(["attended a protest","traveled out of state for the first time","read a book that changed everything","had a spiritual experience","saw a concert that blew their mind"]) + ".",
        "Earned a scholarship or academic award.",
        "Stood up for someone weaker and gained a reputation.",
        "Reconciled with an estranged family member.",
        "Fell in love for the first time — it was genuine.",
        "Built something with their own hands they were proud of.",
        "Saved someone's life in an emergency.",
        "Was accepted into a college or program they dreamed of.",
        "Made a group of loyal friends who felt like family."
      ]), "positive");
    }
  }

  // Teen personality evolution
  C.teenTraits = [
    pick(DATA.personalityTraits.positive),
    pick(DATA.personalityTraits.negative),
    pick(DATA.personalityTraits.neutral)
  ];

  // ─── YOUNG ADULTHOOD (18+, up to game start ~1980-82) ───
  C.gameStartYear = rollRange(1980, 1982);
  C.gameStartAge = C.gameStartYear - C.birthYear;

  C.adultPath = weightedPick([
    {v:"college",w:20},{v:"military",w:15},{v:"workforce",w:25},{v:"trade_school",w:10},
    {v:"criminal",w:8},{v:"drifter",w:7},{v:"married_young",w:8},{v:"artist",w:5},{v:"streets",w:5}
  ]);

  // Adjust based on earlier life
  if (C.teenAcademics === "dropped out") {
    if (C.adultPath === "college") C.adultPath = pick(["workforce","military","criminal","drifter"]);
  }
  if (C.teenAcademics === "class valedictorian" && chance(70)) C.adultPath = "college";

  C.adultEvents = [];
  const addAdultEvent = (year, text, type) => C.adultEvents.push({year, text, type});

  // ─── EARLY ADULT PATH (18-22) ───
  switch(C.adultPath) {
    case "college":
      C.adultPathDesc = "Went to " + pick(["a state university","a community college","a small liberal arts college","a large public university","a private university on scholarship"]);
      C.major = pick(["English","History","Business","Engineering","Pre-Med","Psychology","Political Science","Art","Education","Biology","Journalism","Sociology","Criminal Justice","Computer Science","Undeclared"]);
      C.adultPathDesc += ", studying " + C.major + ".";
      if (chance(25)) addAdultEvent(C.birthYear + 19, "Nearly flunked out after a wild freshman year.", "negative");
      if (chance(20)) addAdultEvent(C.birthYear + 20, "Changed majors after a crisis of purpose.", "neutral");
      C.droppedOut = chance(15);
      if (C.droppedOut) {
        addAdultEvent(C.birthYear + 20, "Dropped out of college after " + pick(["running out of money","a family emergency","failing grades","getting involved with the wrong crowd","a mental breakdown"]) + ".", "negative");
      } else {
        addAdultEvent(C.birthYear + 22, "Graduated and entered the workforce with big dreams.", "positive");
      }
      break;
    case "military":
      C.branch = pick(["Army","Marines","Navy","Air Force"]);
      C.adultPathDesc = "Enlisted in the " + C.branch + " right out of high school.";
      if (chance(30)) {
        addAdultEvent(C.birthYear + 19, "Shipped out and experienced combat — came back different.", "negative");
        C.adultPathDesc += " Saw action overseas.";
      }
      if (chance(20)) addAdultEvent(C.birthYear + 20, "Earned a commendation for bravery or service.", "positive");
      C.dishonorableDischarge = chance(15);
      if (C.dishonorableDischarge) {
        addAdultEvent(C.birthYear + 21, "Received a dishonorable discharge after " + pick(["a fight","insubordination","drug use","going AWOL"]) + ".", "negative");
      } else {
        if (chance(40)) addAdultEvent(C.birthYear + 22, "Completed service and was honorably discharged.", "positive");
        else addAdultEvent(C.birthYear + 21, "Found structure and purpose in military life — re-enlisted.", "positive");
      }
      break;
    case "trade_school":
      C.trade = pick(["auto mechanic","electrician","plumber","welder","HVAC technician","carpenter","machinist","diesel mechanic"]);
      C.adultPathDesc = "Went to trade school to become a " + C.trade + ".";
      addAdultEvent(C.birthYear + 20, "Got certified and started earning decent money right away.", "positive");
      break;
    case "workforce":
      C.firstJob = pick(["factory","warehouse","retail","restaurant","construction","office","gas station","trucking company","hospital (orderly)","landscaping crew"]);
      C.adultPathDesc = "Went straight into the workforce, starting at a " + C.firstJob + ".";
      if (chance(30)) addAdultEvent(C.birthYear + 19, "Got promoted early — showed real aptitude.", "positive");
      if (chance(20)) addAdultEvent(C.birthYear + 21, "Was laid off during an economic downturn.", "negative");
      break;
    case "criminal":
      C.crimeType = pick(["dealing drugs","running numbers","burglary","armed robbery","car theft","fraud","fencing stolen goods"]);
      C.adultPathDesc = "Fell into a life of crime — " + C.crimeType + ".";
      if (chance(40)) addAdultEvent(C.birthYear + 19, "Did a stint in county jail — " + rollRange(3,18) + " months.", "negative");
      if (chance(20)) addAdultEvent(C.birthYear + 20, "Made a lot of fast money but at a heavy cost.", "neutral");
      if (chance(30)) addAdultEvent(C.birthYear + 21, "Was betrayed by a partner and barely escaped a long sentence.", "negative");
      break;
    case "drifter":
      C.adultPathDesc = "Hit the road — drifted from town to town, picking up odd jobs.";
      if (chance(30)) addAdultEvent(C.birthYear + 19, "Lived in a commune for a while — found temporary peace.", "positive");
      if (chance(30)) addAdultEvent(C.birthYear + 20, "Was robbed and beaten on the road.", "negative");
      if (chance(25)) addAdultEvent(C.birthYear + 21, "Met someone who briefly gave life meaning.", "positive");
      break;
    case "married_young":
      C.spouseName = pick(C.gender === 'male' ? DATA.femaleFirst : DATA.maleFirst);
      C.adultPathDesc = "Married " + C.spouseName + " " + pick(DATA.last) + " right out of high school.";
      if (chance(40)) { addAdultEvent(C.birthYear + 19, "Had their first child.", "positive"); C.hasKid = true; }
      if (chance(30)) addAdultEvent(C.birthYear + 21, "The marriage started showing cracks early.", "negative");
      if (chance(20)) addAdultEvent(C.birthYear + 23, "Divorced after " + pick(["infidelity","financial stress","growing apart","abuse"]) + ".", "negative");
      break;
    case "artist":
      C.artForm = pick(["music","painting","writing","acting","photography","filmmaking","sculpture","poetry"]);
      C.adultPathDesc = "Pursued " + C.artForm + " — the only thing that ever felt real.";
      if (chance(25)) addAdultEvent(C.birthYear + 20, "Got a small break — " + pick(["a gallery show","a gig at a real venue","a published story","a role in a local production","a piece in a magazine"]) + ".", "positive");
      if (chance(35)) addAdultEvent(C.birthYear + 21, "Struggled to make rent — the art life was brutal.", "negative");
      break;
    case "streets":
      C.adultPathDesc = "Ended up on the streets — homeless and surviving day to day.";
      addAdultEvent(C.birthYear + 18, pick(["Addiction took hold and everything fell apart.","Was kicked out of the family home with nothing.","A series of bad breaks left them with no safety net.","Mental health struggles made holding anything together impossible."]), "negative");
      if (chance(30)) addAdultEvent(C.birthYear + 20, "Found help at a shelter — a small lifeline.", "positive");
      if (chance(30)) addAdultEvent(C.birthYear + 19, "Was arrested for vagrancy and spent time in lockup.", "negative");
      break;
  }

  // ─── MID-TO-LATE 20s EVENTS (23 to game start) ───
  // These fill the gap and make the adult life feel lived-in
  const midAdultStart = C.birthYear + 23;
  const midAdultEnd = C.gameStartYear;

  // Career progression or change
  if (midAdultEnd > midAdultStart) {
    const careerYear = rollRange(midAdultStart, midAdultEnd);
    addAdultEvent(careerYear, weightedPick([
      {v:"Settled into a steady job as a " + pick(["bartender","mechanic","factory supervisor","office worker","store manager","truck driver","security guard","cook at a diner","postal worker","construction foreman","cab driver","janitor","nurse's aide","warehouse manager","insurance adjuster"]) + ".", w:25},
      {v:"Got fired and had to scramble to find work.", w:10},
      {v:"Started a small business — " + pick(["a repair shop","a food stand","a lawn care service","a cleaning company","a used car lot","a barber shop"]) + ".", w:8},
      {v:"Worked two jobs just to keep the lights on.", w:12},
      {v:"Got a promotion that changed their financial situation.", w:8},
      {v:"Landed a union job with real benefits for the first time.", w:7},
      {v:"Was injured on the job — workers' comp barely covered it.", w:8},
      {v:"Bounced between dead-end jobs, never finding anything that stuck.", w:10},
      {v:"Found unexpected success in a career they never planned on.", w:5},
      {v:"Went back to school at night to try to improve their prospects.", w:7}
    ]), pick(["positive","negative","neutral"]));
  }

  // Relationship in the mid-20s+
  if (!C.hasKid && midAdultEnd > midAdultStart) {
    const relYear = rollRange(midAdultStart, midAdultEnd);
    if (chance(60)) {
      addAdultEvent(relYear, weightedPick([
        {v:"Got married — it felt like the right time.", w:15},
        {v:"Moved in with a partner — things were good for a while.", w:15},
        {v:"Had a child — everything suddenly had stakes.", w:12},
        {v:"Went through a brutal breakup that sent them spiraling.", w:12},
        {v:"Started a serious relationship with someone from work.", w:10},
        {v:"Got engaged but it fell apart before the wedding.", w:8},
        {v:"Had an affair that blew up their life.", w:8},
        {v:"Realized they preferred being alone.", w:8},
        {v:"Married someone they didn't love, for stability.", w:6},
        {v:"Rekindled things with their high school sweetheart.", w:6}
      ]), pick(["positive","negative","neutral"]));
    }
  }

  // Life event in the late 20s
  if (midAdultEnd > midAdultStart + 2) {
    const lateYear = rollRange(midAdultStart + 1, midAdultEnd);
    addAdultEvent(lateYear, weightedPick([
      {v:"Moved to a new city for a fresh start — " + pick(["Houston","Dallas","Denver","Phoenix","Chicago","Atlanta","San Diego","Portland","New Orleans","Tucson"]) + ".", w:10},
      {v:"Bought a used " + pick(["'74 Ford F-150","'77 Chevy Impala","'73 Dodge Dart","'76 AMC Pacer","'78 Pontiac Firebird","'71 Plymouth Valiant","'75 Oldsmobile Cutlass","'79 Chevy El Camino"]) + " — the first vehicle that actually ran reliably.", w:8},
      {v:"Got into a bar fight that went too far — spent a night in jail.", w:7},
      {v:"A parent passed away — it hit harder than expected.", w:10},
      {v:"Inherited the family house — a blessing and a burden.", w:5},
      {v:"Was in a serious car accident — took months to recover.", w:7},
      {v:"Got clean after years of substance abuse.", w:6},
      {v:"Slipped deeper into addiction — lost months in a haze.", w:7},
      {v:"Got involved in local politics or community organizing.", w:4},
      {v:"Was robbed at gunpoint — changed the way they saw the world.", w:6},
      {v:"Took in a younger sibling or relative who had nowhere else to go.", w:5},
      {v:"Saved up enough to put a down payment on a small place.", w:5},
      {v:"Had a religious or spiritual crisis — questioned everything they believed.", w:5},
      {v:"Went to prison for " + rollRange(1,4) + " years — came out a different person.", w:5},
      {v:"Traveled across the country — saw things that broadened their perspective.", w:5},
      {v:"A close friend died unexpectedly — " + pick(["cancer","car accident","overdose","heart attack","murder"]) + ".", w:8}
    ]), pick(["positive","negative","neutral"]));
  }

  // One more possible event
  if (midAdultEnd > midAdultStart + 3 && chance(60)) {
    const bonusYear = rollRange(midAdultStart + 2, midAdultEnd);
    addAdultEvent(bonusYear, weightedPick([
      {v:"Started coaching a local youth " + pick(["baseball","football","basketball","boxing"]) + " team.", w:8},
      {v:"Got a dog — the most loyal companion they'd ever have.", w:8},
      {v:"Was diagnosed with " + pick(["chronic back pain","an ulcer","high blood pressure","early arthritis","migraines","depression"]) + " — a reminder they weren't invincible.", w:10},
      {v:"Reconnected with an old friend from childhood — it felt like no time had passed.", w:8},
      {v:"Had a second child — the family was growing.", w:6},
      {v:"Became the person people in the neighborhood came to for help.", w:6},
      {v:"Got scammed out of a significant amount of money.", w:7},
      {v:"Won a local " + pick(["poker tournament","fishing derby","chili cook-off","bowling league","arm wrestling contest","pool tournament"]) + " — still brags about it.", w:5},
      {v:"Took up " + pick(["hunting","fishing","woodworking","restoring old cars","gardening","amateur radio","photography"]) + " as a way to stay sane.", w:8},
      {v:"Had a one-night stand that resulted in a child they didn't know about.", w:4},
      {v:"Testified in court — either as a witness or a defendant.", w:6},
      {v:"Helped a stranger in a crisis and it restored some faith in themselves.", w:7},
      {v:"Fell into gambling — sometimes won big, usually didn't.", w:6},
      {v:"Earned the respect of their coworkers — became a quiet leader.", w:7}
    ]), pick(["positive","negative","neutral"]));
  }

  // Additional adult events (original catch-all)
  for (let i = 0; i < rollRange(1,3); i++) {
    const yr = C.birthYear + rollRange(18, C.gameStartAge);
    if (chance(50)) {
      addAdultEvent(yr, pick([
        "Had a brush with death — " + pick(["car accident","overdose","violent altercation","illness","near-drowning"]) + ".",
        "Lost everything in a " + pick(["fire","flood","bad investment","gambling binge","scam"]) + ".",
        "A mentor or important figure in their life died.",
        "Developed a serious " + pick(["drinking problem","drug habit","gambling addiction"]) + ".",
        "Was arrested for " + pick(["assault","DUI","drug possession","public intoxication","breaking and entering"]) + ".",
        "Suffered a betrayal that shattered their trust.",
        "Experienced a traumatic event they don't talk about.",
        "Had a child they had to give up or couldn't support.",
        "Got deeply into debt."
      ]), "negative");
    } else {
      addAdultEvent(yr, pick([
        "Made a genuine friend who would have their back through anything.",
        "Had a spiritual or philosophical awakening.",
        "Came into some money — " + pick(["a small inheritance","a lucky break","a good investment","won a bet","back pay from a lawsuit"]) + ".",
        "Kicked a bad habit and started fresh.",
        "Fell in love for real — the kind that changes you.",
        "Found a calling or purpose they hadn't expected.",
        "Reconciled with family after years of distance.",
        "Helped someone in crisis — reminded them they still had good in them.",
        "Earned respect in their community for " + pick(["their work ethic","their generosity","their toughness","their honesty","their talent"]) + "."
      ]), "positive");
    }
  }

  // ─── CURRENT STATUS ───
  C.currentTraits = [
    pick(DATA.personalityTraits.positive),
    pick(DATA.personalityTraits.positive),
    pick(DATA.personalityTraits.negative),
    pick(DATA.personalityTraits.negative),
    pick(DATA.personalityTraits.neutral),
    pick(DATA.personalityTraits.neutral)
  ];
  // Remove duplicates
  C.currentTraits = [...new Set(C.currentTraits)];

  C.currentFear = pick(DATA.fears);
  C.currentMotivation = pick([
    "survival — just getting through the day","redemption for past sins","protecting someone they love",
    "making enough money to escape","proving everyone wrong","finding a place to belong",
    "revenge against someone who wronged them","finding meaning or purpose","escaping their past",
    "getting back what was taken from them","building something that lasts","making their parent proud",
    "honoring someone who died","atoning for a terrible mistake","pure ambition — they want to be someone",
    "freedom — from responsibility, from the law, from expectations","finding out who they really are",
    "keeping a promise they made long ago","providing for their child","getting clean and staying clean"
  ]);

  // Financial status
  C.financialStatus = weightedPick([
    {v:"Destitute — barely surviving",w:10},{v:"Poor — living paycheck to paycheck",w:25},
    {v:"Working class — getting by",w:25},{v:"Comfortable — modest but stable",w:20},
    {v:"Well off — has savings and security",w:12},{v:"Wealthy — significant resources",w:5},
    {v:"Deeply in debt",w:8}
  ]);

  // Living situation
  C.livingSituation = weightedPick([
    {v:"a rundown studio apartment",w:15},{v:"a shared house with roommates",w:12},
    {v:"their parents' house (still)",w:10},{v:"a modest apartment",w:15},
    {v:"a rented house",w:10},{v:"a nice apartment",w:8},
    {v:"their own home (mortgaged)",w:8},{v:"their car",w:5},
    {v:"a shelter or the streets",w:4},{v:"a trailer",w:7},
    {v:"a motel room",w:4},{v:"a halfway house",w:3},
    {v:"with their spouse/partner",w:8}
  ]);

  // Physical description
  C.height = C.gender === 'male' ? pick(["5'6\"","5'7\"","5'8\"","5'9\"","5'10\"","5'11\"","6'0\"","6'1\"","6'2\"","6'3\""]) : pick(["5'0\"","5'1\"","5'2\"","5'3\"","5'4\"","5'5\"","5'6\"","5'7\"","5'8\""]);
  C.build = weightedPick([
    {v:"thin",w:15},{v:"lean",w:15},{v:"average",w:25},{v:"stocky",w:12},
    {v:"heavyset",w:10},{v:"muscular",w:10},{v:"wiry",w:8},{v:"gaunt",w:5}
  ]);
  C.hair = pick(["black","dark brown","brown","light brown","dirty blond","blond","red","auburn","graying early"]);
  C.eyes = pick(["brown","dark brown","hazel","green","blue","gray","blue-green"]);
  C.distinguishing = pick([
    "a scar across the left cheek","a chipped front tooth","calloused hands from hard labor",
    "a crooked nose (broken twice)","tattoos from a rough period","nervous eyes that never stop moving",
    "a warm, easy smile","an intense, piercing gaze","a limp from an old injury",
    "burn scars on one arm","freckles across the nose and cheeks","prematurely gray temples",
    "a prominent birthmark","cigarette-stained fingers","a missing finger on the left hand",
    "deep laugh lines","dark circles under the eyes","a confident walk and easy posture",
    "fidgeting hands — always moving","a soft voice that makes people lean in"
  ]);

  // Quirks and habits
  C.habits = [];
  for (let i = 0; i < rollRange(2,4); i++) {
    C.habits.push(pick([
      "smokes a pack a day","drinks too much coffee","bites their nails",
      "cracks their knuckles constantly","hums when nervous","can't sit still",
      "always carries a pocket knife","talks to themselves when thinking",
      "keeps a journal","collects something odd","is superstitious about certain things",
      "always sits with their back to the wall","never makes eye contact when lying",
      "drums their fingers on every surface","wakes up before dawn every day",
      "can't sleep without the radio on","reads the newspaper back to front",
      "always tips generously despite being broke","never throws anything away",
      "compulsively checks locks","whistles when walking alone"
    ]));
  }
  C.habits = [...new Set(C.habits)];

  // Skills from life experience
  C.skills = [];
  if (C.adultPath === "military") C.skills.push("firearms proficiency","discipline under pressure","first aid");
  if (C.adultPath === "criminal") C.skills.push("streetwise","lock picking","fast talking");
  if (C.adultPath === "trade_school") C.skills.push(C.trade + " expertise","mechanical aptitude");
  if (C.adultPath === "college") C.skills.push("research","educated vocabulary","critical thinking");
  if (C.adultPath === "drifter") C.skills.push("survival skills","reading people","adaptability");
  if (C.adultPath === "artist") C.skills.push(C.artForm + " talent","creative problem solving");
  if (C.adultPath === "streets") C.skills.push("street survival","scrounging","invisibility in crowds");
  if (C.adultPath === "workforce") C.skills.push("hard work ethic","practical knowledge","reliability");
  if (C.adultPath === "married_young") C.skills.push("domestic skills","patience","multitasking");

  C.skills.push(pick(["cooking","driving","negotiation","intimidation","charm","athletics","observation","stealth","quick reflexes","endurance","animal handling","navigation","swimming","climbing"]));
  C.skills.push(pick(["local knowledge","storytelling","gambling","bartering","forgery","disguise","jury-rigging","music","drawing","first aid","hunting","fishing","sewing","typing"]));
  C.skills = [...new Set(C.skills)];

  // Connections
  C.connections = [];
  C.connections.push(pick([
    "an old friend from childhood who still checks in","a sibling they're close to","a bartender who knows all their secrets",
    "an ex who still carries a torch","a mentor who gave them a chance","a neighbor who looks out for them",
    "a coworker they trust with their life","nobody — they've burned every bridge"
  ]));
  C.connections.push(pick([
    "owes money to a dangerous person","has an enemy from their past","has a warrant in another state",
    "has an estranged child somewhere","has a family member in prison","has a rival who wants to see them fail",
    "has a secret that could destroy them","has unfinished business with someone from their teen years"
  ]));

  // Possessions
  C.prizedPossession = pick([
    "a faded photograph of someone they lost","a pocket knife their grandfather gave them",
    "a dog-eared paperback that changed their life","a class ring they never take off",
    "a beat-up guitar","a lighter with an inscription","a letter they've never sent",
    "a military medal","a pressed flower from their first love","a worn leather jacket",
    "a set of keys to a place that no longer exists","a locket with a photo inside",
    "a hand-drawn map from childhood","a vinyl record they've kept since they were 14",
    "a bullet they was meant to kill them","their father's watch (broken)"
  ]);

  return C;
}

// ─── RENDER ───
function render(C) {
  const sortEvents = (events) => [...events].sort((a, b) => a.year - b.year);

  let html = '';

  // ═══ PAGE 1: VITAL STATISTICS ═══
  html += `<div class="page">
    <div class="stamp">${C.gender === 'male' ? 'Male' : 'Female'}</div>
    <div class="page-header">
      I. Vital Statistics
      <span class="era">Born ${C.birthYear}</span>
    </div>
    <div class="stat-block">
      <div class="stat"><span class="label">Full Name:</span><br>${C.fullName}</div>
      <div class="stat"><span class="label">Date of Birth:</span><br>${pick(['January','February','March','April','May','June','July','August','September','October','November','December'])} ${rollRange(1,28)}, ${C.birthYear}</div>
      <div class="stat"><span class="label">Birthplace:</span><br>${C.birthCity.name}</div>
      <div class="stat"><span class="label">Ethnicity:</span><br>${C.ethnicity}</div>
      <div class="stat"><span class="label">Religion:</span><br>${C.religion}</div>
      <div class="stat"><span class="label">Birth Event:</span><br>${C.birthEvent}</div>
    </div>
    <div class="section-divider">— PHYSICAL DESCRIPTION —</div>
    <div class="stat-block">
      <div class="stat"><span class="label">Height:</span><br>${C.height}</div>
      <div class="stat"><span class="label">Build:</span><br>${C.build}</div>
      <div class="stat"><span class="label">Hair:</span><br>${C.hair}</div>
      <div class="stat"><span class="label">Eyes:</span><br>${C.eyes}</div>
    </div>
    <div class="stat"><span class="label">Distinguishing Feature:</span> ${C.distinguishing}</div>
  </div>`;

  // ═══ PAGE 2: FAMILY ═══
  html += `<div class="page">
    <div class="page-header">
      II. Family Background
      <span class="era">${C.birthYear - 1}–${C.birthYear + 5}</span>
    </div>
    <div class="stat-block">
      <div class="stat"><span class="label">Father:</span><br>${C.dadFirst} ${C.lastName} — ${C.dadJob.job}</div>
      <div class="stat"><span class="label">Mother:</span><br>${C.momFirst} ${C.momMaiden} ${C.lastName} — ${C.momJob.job}</div>
      <div class="stat"><span class="label">Father's Temperament:</span><br>${C.dadPersonality}</div>
      <div class="stat"><span class="label">Mother's Temperament:</span><br>${C.momPersonality}</div>
      <div class="stat"><span class="label">Siblings:</span><br>${C.siblings === 0 ? 'None (only child)' : C.siblings + ' — ' + C.birthOrder}</div>
      <div class="stat"><span class="label">Social Class:</span><br>${C.familyClass}</div>
      <div class="stat"><span class="label">Home:</span><br>${C.birthCity.name}</div>
      <div class="stat"><span class="label">Household Religion:</span><br>${C.religion}</div>
    </div>
    <p class="narrative"><strong>Family dynamic:</strong> ${C.parentRelationship}. ${C.dadFirst} was ${C.dadPersonality}. ${C.momFirst} was ${C.momPersonality}.</p>
  </div>`;

  // ═══ PAGE 3: CHILDHOOD ═══
  html += `<div class="page">
    <div class="page-header">
      III. Childhood
      <span class="era">${C.birthYear + 1}–${C.birthYear + 12}</span>
    </div>
    <p class="narrative">${C.firstName} ${C.elementaryExperience}. As a kid, ${C.gender === 'male' ? 'he' : 'she'} spent most of ${C.gender === 'male' ? 'his' : 'her'} free time ${C.childhoodHobby}. ${C.gender === 'male' ? 'He' : 'She'} ${C.childhoodDream}. ${C.gender === 'male' ? 'His' : 'Her'} deepest fear was ${C.childhoodFear}.</p>
    <div class="trait-list">
      ${C.childhoodTraits.map(t => {
        const type = DATA.personalityTraits.positive.includes(t) ? 'positive' : DATA.personalityTraits.negative.includes(t) ? 'negative' : 'neutral';
        return `<span class="trait-tag ${type}">${t}</span>`;
      }).join('')}
    </div>
    ${sortEvents(C.childhoodEvents).map(e => `
      <div class="event-block ${e.type}">
        <div class="event-year">${e.year} (Age ${e.year - C.birthYear})</div>
        <div class="event-text">${e.text}</div>
      </div>
    `).join('')}
  </div>`;

  // ═══ PAGE 4: TEEN YEARS ═══
  html += `<div class="page">
    <div class="page-header">
      IV. The Teen Years
      <span class="era">${C.birthYear + 13}–${C.birthYear + 17}</span>
    </div>
    <div class="stat-block">
      <div class="stat"><span class="label">School:</span><br>${C.highSchoolType}</div>
      <div class="stat"><span class="label">Academics:</span><br>${C.teenAcademics}</div>
      <div class="stat"><span class="label">Social Group:</span><br>${C.teenSocial}</div>
      <div class="stat"><span class="label">Favorite Music:</span><br>${C.musicTaste}</div>
    </div>
    <p class="narrative">${C.firstName} was ${C.teenSocial} at ${C.gender === 'male' ? 'his' : 'her'} ${C.highSchoolType}. Academically, ${C.gender === 'male' ? 'he' : 'she'} was ${C.teenAcademics === 'dropped out' ? 'a dropout — never finished' : 'an ' + C.teenAcademics}. ${C.gender === 'male' ? 'He' : 'She'} spent ${C.gender === 'male' ? 'his' : 'her'} time ${C.teenHobby}. ${C.firstName} ${C.firstLove}.</p>
    <div class="trait-list">
      ${C.teenTraits.map(t => {
        const type = DATA.personalityTraits.positive.includes(t) ? 'positive' : DATA.personalityTraits.negative.includes(t) ? 'negative' : 'neutral';
        return `<span class="trait-tag ${type}">${t}</span>`;
      }).join('')}
    </div>
    ${sortEvents(C.teenEvents).map(e => `
      <div class="event-block ${e.type}">
        <div class="event-year">${e.year} (Age ${e.year - C.birthYear})</div>
        <div class="event-text">${e.text}</div>
      </div>
    `).join('')}
  </div>`;

  // ═══ PAGE 5: YOUNG ADULTHOOD ═══
  html += `<div class="page">
    <div class="page-header">
      V. Young Adulthood
      <span class="era">${C.birthYear + 18}–${C.gameStartYear}</span>
    </div>
    <p class="narrative">${C.adultPathDesc}</p>
    ${sortEvents(C.adultEvents).map(e => `
      <div class="event-block ${e.type}">
        <div class="event-year">${e.year} (Age ${e.year - C.birthYear})</div>
        <div class="event-text">${e.text}</div>
      </div>
    `).join('')}
  </div>`;

  // ═══ PAGE 6: CURRENT STATUS ═══
  html += `<div class="page">
    <div class="stamp">Active — ${C.gameStartYear}</div>
    <div class="page-header">
      VI. Current Status
      <span class="era">${C.gameStartYear} — Age ${C.gameStartAge}</span>
    </div>
    <div class="summary-grid">
      <div class="summary-card"><div class="card-label">Age</div><div class="card-value">${C.gameStartAge}</div></div>
      <div class="summary-card"><div class="card-label">Financial Status</div><div class="card-value" style="font-size:0.9rem">${C.financialStatus}</div></div>
      <div class="summary-card"><div class="card-label">Living In</div><div class="card-value" style="font-size:0.9rem">${C.livingSituation}</div></div>
      <div class="summary-card"><div class="card-label">Motivation</div><div class="card-value" style="font-size:0.85rem">${C.currentMotivation}</div></div>
    </div>
    <div class="section-divider">— PERSONALITY —</div>
    <div class="trait-list">
      ${C.currentTraits.map(t => {
        const type = DATA.personalityTraits.positive.includes(t) ? 'positive' : DATA.personalityTraits.negative.includes(t) ? 'negative' : 'neutral';
        return `<span class="trait-tag ${type}">${t}</span>`;
      }).join('')}
    </div>
    <div class="section-divider">— DEEPEST FEAR —</div>
    <p class="narrative" style="text-indent:0;text-align:center;font-style:italic;">${C.currentFear}</p>
    <div class="section-divider">— SKILLS —</div>
    <div class="trait-list">
      ${C.skills.map(s => `<span class="trait-tag neutral">${s}</span>`).join('')}
    </div>
    <div class="section-divider">— HABITS & QUIRKS —</div>
    <p class="narrative" style="text-indent:0">${C.habits.join('; ')}.</p>
    <div class="section-divider">— CONNECTIONS —</div>
    ${C.connections.map(c => `<p class="narrative" style="text-indent:0">• ${c}</p>`).join('')}
    <div class="section-divider">— PRIZED POSSESSION —</div>
    <p class="narrative" style="text-indent:0;text-align:center;font-style:italic;">${C.prizedPossession}</p>
  </div>`;

  // ═══ PAGE 7: MIDJOURNEY PROMPT ═══
  html += `<div class="page">
    <div class="stamp">Midjourney</div>
    <div class="page-header">
      VII. Character Portrait Prompt
      <span class="era">Midjourney v6+</span>
    </div>
    <p class="narrative" style="text-indent:0;font-size:0.85rem;margin-bottom:8px;">Choose a look style, optionally add your own physical descriptors, then copy the generated prompt for Midjourney.</p>

    <div class="portrait-controls">
      <div class="section-divider">— PORTRAIT STYLE —</div>
      <div class="style-buttons">
        <button class="style-btn active" onclick="setPortraitStyle('natural', this)">
          Natural
          <span class="style-sub">Average everyday person</span>
        </button>
        <button class="style-btn" onclick="setPortraitStyle('rough', this)">
          Rough
          <span class="style-sub">Hard miles, harder living</span>
        </button>
        <button class="style-btn" onclick="setPortraitStyle('cleaned_up', this)">
          Cleaned Up
          <span class="style-sub">Presentable, put-together</span>
        </button>
        <button class="style-btn" onclick="setPortraitStyle('worn', this)">
          Worn Down
          <span class="style-sub">Life took its toll</span>
        </button>
      </div>
    </div>

    <div class="custom-desc-area">
      <button class="custom-desc-toggle" onclick="toggleCustomDesc()">+ Add your own physical details</button>
      <div class="custom-desc-panel" id="custom-desc-panel">
        <label for="custom-desc-input">Custom Physical Descriptors</label>
        <textarea id="custom-desc-input" placeholder="e.g. beer gut, missing teeth, acne scars, big nose, receding hairline, broad shoulders, freckled, weathered hands, lazy eye, gap teeth, sun damaged skin, crow's feet around the eyes..." oninput="rebuildPrompt()"></textarea>
        <div class="desc-hint">These get added directly into the prompt. Be as specific as you want — or leave blank to use only the generated description.</div>
      </div>
    </div>

    <div class="section-divider">— GENERATED PROMPT —</div>
    <div class="mj-prompt-box" id="mj-prompt"></div>
    <div class="prompt-actions">
      <button class="copy-btn" onclick="copyPrompt(this)">Copy Prompt</button>
      <button class="copy-btn" onclick="rerollPrompt(this)">Re-roll Details</button>
    </div>
    <p class="mj-note">Each style changes the look and feel. "Re-roll" randomizes the road, lighting, and background. Works with Midjourney v5, v6, and Niji.</p>
  </div>`;

  return html;
}

// ─── PORTRAIT SYSTEM ───
let currentPortraitStyle = 'natural';
let currentRoadDetails = null;
let currentTimeOfDay = null;
let currentBgDetails = null;

function setPortraitStyle(style, btn) {
  currentPortraitStyle = style;
  document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  rebuildPrompt();
}

function toggleCustomDesc() {
  const panel = document.getElementById('custom-desc-panel');
  panel.classList.toggle('open');
}

function rerollPrompt(btn) {
  currentRoadDetails = null;
  currentTimeOfDay = null;
  currentBgDetails = null;
  rebuildPrompt();
  if (btn) {
    btn.textContent = 'Re-rolled!';
    setTimeout(() => { btn.textContent = 'Re-roll Details'; }, 1000);
  }
}

function rebuildPrompt() {
  if (!currentCharacter) return;
  const promptEl = document.getElementById('mj-prompt');
  if (promptEl) {
    promptEl.textContent = buildMidjourneyPrompt(currentCharacter, currentPortraitStyle);
  }
}

function buildMidjourneyPrompt(C, style) {
  style = style || 'natural';

  const ethMap = {
    "White (Anglo-Saxon)": "Caucasian",
    "White (Irish-American)": "Caucasian, fair-skinned, Irish features",
    "White (Italian-American)": "Caucasian, olive-skinned, Mediterranean features",
    "White (Polish-American)": "Caucasian, Eastern European features",
    "Black (African-American)": "African American, dark skin",
    "Hispanic (Mexican-American)": "Hispanic, brown skin, Mexican American",
    "Hispanic (Puerto Rican)": "Hispanic, Puerto Rican features",
    "Asian (Chinese-American)": "Chinese American, East Asian features",
    "Asian (Japanese-American)": "Japanese American, East Asian features",
    "Native American": "Native American, indigenous features",
    "White (Jewish-American)": "Caucasian, Ashkenazi features",
    "Mixed Race": "mixed race, ambiguous ethnicity"
  };
  const ethDesc = ethMap[C.ethnicity] || "Caucasian";

  // ─── STYLE-SPECIFIC MODIFIERS ───
  let faceModifiers = '';
  let bodyModifiers = '';
  let clothingModifiers = '';
  let antiBeauty = '';

  // Base "real person" modifiers that always apply
  const realPersonBase = "not a model, ordinary person, imperfect features, real human face, candid photograph";

  switch(style) {
    case 'natural':
      faceModifiers = pick([
        "slightly asymmetrical face","average-looking","plain features","unremarkable face",
        "a face you'd see at a gas station","forgettable face with character in the details",
        "neither ugly nor attractive","ordinary features","the kind of face you'd pass on the street"
      ]);
      bodyModifiers = pick([
        "slightly soft around the middle","average physique","not particularly fit",
        "normal body type","a little doughy","naturally proportioned","slightly slouched posture",
        "regular build with no definition"
      ]);
      clothingModifiers = "";
      antiBeauty = "average-looking, not conventionally attractive, unglamorous, no makeup";
      break;

    case 'rough':
      faceModifiers = pick([
        "rough-looking, sun-damaged skin, deep creases","weathered face, broken capillaries on the nose and cheeks",
        "hard face, looks older than they are, crow's feet and forehead lines",
        "rough complexion, pockmarked skin, several days of stubble",
        "leathery sun-beaten face, squinting eyes, chapped lips",
        "haggard face with deep-set eyes, hollow cheeks",
        "ruddy face, visible pores, looks like they've been in a few fights",
        "rough skin, bags under the eyes, permanent frown lines"
      ]);
      bodyModifiers = pick([
        "beer gut visible under the shirt","thick and rough, working man's body","skinny in an unhealthy way",
        "broad but sagging, going to seed","barrel-chested with thick forearms and calloused hands",
        "rangy and raw-boned, hard angles","heavyset with a gut, thick neck",
        "thin and wiry, underfed look, prominent veins"
      ]);
      clothingModifiers = pick([
        ", clothes are dirty and ill-fitting",", sweat-stained shirt, worn-out boots",
        ", cheap clothes that don't quite fit right",", everything looks secondhand and faded"
      ]);
      antiBeauty = "ugly, rough-looking, NOT attractive, weathered, beaten down by life, unglamorous, no makeup, imperfect skin, visible wear and tear";
      break;

    case 'cleaned_up':
      faceModifiers = pick([
        "clean-shaven with a decent haircut","presentable, recently cleaned up",
        "face has character but looks put-together","neatly groomed, trying to look respectable",
        "average face but well-maintained","freshly shaved, hair combed"
      ]);
      bodyModifiers = pick([
        "carrying a few extra pounds but wears it okay","reasonable shape for their age",
        "average build, stands up straight","not fit but not sloppy",
        "presentable build, decent posture"
      ]);
      clothingModifiers = pick([
        ", wearing clean, pressed clothes",", dressed neatly in era-appropriate clothing",
        ", clothes are simple but clean and well-maintained"
      ]);
      antiBeauty = "average-looking, not a model, ordinary person, no glamour, plain but presentable";
      break;

    case 'worn':
      faceModifiers = pick([
        "gaunt face with sunken eyes, premature wrinkles","tired face, dark circles, looks exhausted permanently",
        "face tells a story of hard years, deep nasolabial folds, tired eyes",
        "sallow complexion, thinning hair, looks ten years older",
        "pale and drawn, bloodshot eyes, chewed fingernails visible",
        "face of someone who hasn't slept well in years, worry lines etched deep",
        "unhealthy pallor, patchy facial hair, dry cracked lips",
        "sad eyes, downturned mouth, a face that's given up on smiling"
      ]);
      bodyModifiers = pick([
        "thin in a malnourished way, clothes hang loose","stooped posture, moves like everything hurts",
        "wasted frame, bony shoulders visible through the shirt","skinny-fat, no muscle tone, soft and depleted",
        "frail-looking despite their age, diminished","body language of someone carrying invisible weight"
      ]);
      clothingModifiers = pick([
        ", clothes are wrinkled and starting to fall apart",", wearing the same clothes they've worn for days",
        ", clothes are clean but threadbare and faded",", dressed in whatever was available, nothing matches"
      ]);
      antiBeauty = "haggard, worn out, beaten down, NOT attractive, life has been hard, unglamorous, sickly, exhausted, no makeup";
      break;
  }

  // Clothing base from life path
  const clothingOptions = {
    college: ["wearing a worn university t-shirt and jeans", "wearing a button-down shirt with rolled sleeves and khakis", "wearing a sweater vest over a collared shirt"],
    military: ["wearing a faded olive drab military jacket and dog tags", "wearing a surplus Army field jacket and boots", "wearing a tight white t-shirt and military-issue trousers"],
    workforce: ["wearing a work shirt with the sleeves rolled up, grease-stained jeans", "wearing a flannel shirt and steel-toe boots", "wearing coveralls unzipped to the waist over a stained undershirt"],
    trade_school: ["wearing a work shirt and heavy denim, tool belt visible", "wearing a grease-stained mechanic's shirt with a name patch", "wearing a flannel and work boots"],
    criminal: ["wearing a leather jacket over a dark shirt, gold chain visible", "wearing a flashy silk shirt unbuttoned at the collar", "wearing a denim vest and cowboy boots, a switchblade outline in the pocket"],
    drifter: ["wearing a sun-faded denim jacket covered in road dust, a bandana around the neck", "wearing layers of mismatched thrift-store clothes, a worn backpack", "wearing a threadbare flannel, patched jeans, and hitchhiker boots"],
    married_young: ["wearing a simple button-down and clean jeans", "wearing a polo shirt and slacks, looking tired but put-together", "wearing a house dress and sandals"],
    artist: ["wearing a paint-splattered denim jacket and beret", "wearing a thrift-store blazer over a band t-shirt", "wearing all black with silver rings on every finger"],
    streets: ["wearing torn, dirty clothes, a stained Army surplus coat", "wearing a hoodie with holes, unwashed jeans, and worn-out sneakers", "wearing whatever they could find, mismatched, weathered, lived-in"]
  };
  const clothing = pick(clothingOptions[C.adultPath] || clothingOptions.workforce) + clothingModifiers;

  // Expression based on personality and life events
  const negCount = C.adultEvents.filter(e => e.type === "negative").length + C.teenEvents.filter(e => e.type === "negative").length;
  const posCount = C.adultEvents.filter(e => e.type === "positive").length + C.teenEvents.filter(e => e.type === "positive").length;

  let expression;
  if (style === 'rough' || style === 'worn') {
    expression = pick(["hollow distant stare","weary eyes and a hard-set jaw","haunted expression","guarded expression eyes narrowed","exhausted but defiant expression","thousand-yard stare","dead eyes","blank resigned expression","suspicious glare"]);
  } else if (negCount > posCount + 3) {
    expression = pick(["hollow distant stare","weary eyes and a hard-set jaw","haunted expression","guarded expression eyes narrowed against the sun","exhausted but defiant expression"]);
  } else if (posCount > negCount + 2) {
    expression = pick(["quiet confidence in the eyes","easy half-smile","warm but weathered expression","knowing grin","calm self-assured expression"]);
  } else {
    expression = pick(["neutral expression with a hint of weariness","complex expression","stoic face unreadable eyes","subtle smirk guarded eyes","tired but alert expression scanning the horizon"]);
  }

  // Build description
  const buildDesc = {
    "thin": "thin frame", "lean": "lean build", "average": "average build", "stocky": "stocky broad-shouldered",
    "heavyset": "heavyset thick-bodied", "muscular": "muscular strong build", "wiry": "wiry sinewy frame", "gaunt": "gaunt angular features"
  };
  const buildText = buildDesc[C.build] || "average build";

  // Hair
  let hairDesc = C.hair + " hair";
  if (C.gender === 'male') {
    hairDesc += " " + pick(["slightly overgrown","parted to the side","slicked back","shaggy and unkempt","buzz cut","feathered 70s style","with thick sideburns","curly and wild","combed neat","thinning on top","receding hairline","greasy and unwashed"]);
  } else {
    hairDesc += " " + pick(["feathered Farrah Fawcett style","long and straight","pulled back in a ponytail","short and boyish","curly and voluminous","parted in the middle","pinned up loosely","windswept and tangled","braided","frizzy and unstyled","tied back with a rubber band"]);
  }

  // Distinguishing marks
  let markDesc = "";
  if (C.distinguishing.includes("scar")) markDesc = ", visible scar on face";
  else if (C.distinguishing.includes("tattoo")) markDesc = ", faded tattoos visible on arms";
  else if (C.distinguishing.includes("burn")) markDesc = ", burn scars on one arm";
  else if (C.distinguishing.includes("limp")) markDesc = ", standing with weight shifted to one side";
  else if (C.distinguishing.includes("missing finger")) markDesc = ", missing finger on left hand";
  else if (C.distinguishing.includes("crooked nose")) markDesc = ", crooked broken nose";

  // Custom descriptors from user
  const customInput = document.getElementById('custom-desc-input');
  let customDesc = '';
  if (customInput && customInput.value.trim()) {
    customDesc = ', ' + customInput.value.trim();
  }

  // Road details (re-rollable)
  if (!currentRoadDetails) {
    currentRoadDetails = pick([
      "a long straight two-lane Texas highway stretching to the vanishing point",
      "a dusty empty Texas farm road with cracked asphalt",
      "a sun-scorched Texas highway with heat shimmer rising off the blacktop",
      "a lonely west Texas road cutting through flat scrubland",
      "a desolate Texas panhandle highway under a massive sky",
      "a dirt county road in rural Texas with tire ruts in red clay",
      "a crumbling Texas state highway with faded yellow center line"
    ]);
  }
  if (!currentTimeOfDay) {
    currentTimeOfDay = pick([
      "golden hour light long shadows stretching across the road",
      "harsh midday Texas sun bleached sky",
      "late afternoon light warm amber tones",
      "early morning light soft haze on the horizon",
      "overcast sky with dramatic cloud formations",
      "dusk orange and purple sky fading light"
    ]);
  }
  if (!currentBgDetails) {
    currentBgDetails = pick([
      "rusted barbed wire fence and dry grass alongside the road",
      "a distant water tower and grain elevator on the horizon",
      "oil pump jacks dotting the far background",
      "a faded billboard and a dead mesquite tree",
      "flat empty prairie extending in every direction power lines receding",
      "a broken-down pickup truck on the shoulder behind them",
      "scrub brush and tumbleweeds a distant windmill",
      "cattle fence and an empty dirt lot a rusted mailbox"
    ]);
  }

  const prompt = `Full body portrait of a ${C.gameStartAge}-year-old ${ethDesc} ${C.gender === 'male' ? 'man' : 'woman'}, ${realPersonBase}, ${faceModifiers}, ${bodyModifiers}, ${buildText}, ${C.height} tall, ${hairDesc}, ${C.eyes} eyes, ${expression}${markDesc}${customDesc}, ${clothing}, standing in the middle of ${currentRoadDetails}, ${currentTimeOfDay}, ${currentBgDetails}, late 1970s early 1980s America, ${antiBeauty}, Kodachrome film photography, shot on 35mm Nikon F3, shallow depth of field, photorealistic, documentary photography, cinematic composition, no text, no watermark --ar 2:3 --style raw --s 250`;

  return prompt;
}

function copyPrompt(btn) {
  const promptEl = document.getElementById('mj-prompt');
  const text = '/imagine prompt: ' + promptEl.textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'Copy Prompt';
      btn.classList.remove('copied');
    }, 2000);
  }).catch(() => {
    const range = document.createRange();
    range.selectNodeContents(promptEl);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    btn.textContent = 'Selected — Ctrl+C';
    setTimeout(() => { btn.textContent = 'Copy Prompt'; }, 2000);
  });
}

let currentCharacter = null;

function generate() {
  const output = document.getElementById('output');
  const loading = document.getElementById('loading');
  const exportBar = document.getElementById('export-bar');
  output.classList.remove('visible');
  exportBar.classList.remove('visible');
  loading.classList.add('visible');

  setTimeout(() => {
    currentCharacter = generateCharacter();
    currentPortraitStyle = 'natural';
    currentRoadDetails = null;
    currentTimeOfDay = null;
    currentBgDetails = null;
    output.innerHTML = render(currentCharacter);
    // Build the initial prompt after DOM is ready
    rebuildPrompt();
    loading.classList.remove('visible');
    output.classList.add('visible');
    exportBar.classList.add('visible');
    output.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 800);
}

// ─── EXPORT FUNCTIONS ───

function buildCharText(C) {
  const sortEvents = (events) => [...events].sort((a, b) => a.year - b.year);
  const pronoun = C.gender === 'male' ? 'He' : 'She';
  const possessive = C.gender === 'male' ? 'his' : 'her';

  let t = '';
  t += `════════════════════════════════════════\n`;
  t += `  LIFE PATH DOSSIER: ${C.fullName.toUpperCase()}\n`;
  t += `════════════════════════════════════════\n\n`;

  t += `═══ I. VITAL STATISTICS ═══\n`;
  t += `Name: ${C.fullName}\n`;
  t += `Gender: ${C.gender === 'male' ? 'Male' : 'Female'}\n`;
  t += `Age at Game Start: ${C.gameStartAge} (Born ${C.birthYear})\n`;
  t += `Birthplace: ${C.birthCity.name}\n`;
  t += `Ethnicity: ${C.ethnicity}\n`;
  t += `Religion: ${C.religion}\n`;
  t += `Birth: ${C.birthEvent}\n\n`;

  t += `Physical Description:\n`;
  t += `  Height: ${C.height} | Build: ${C.build}\n`;
  t += `  Hair: ${C.hair} | Eyes: ${C.eyes}\n`;
  t += `  Distinguishing Feature: ${C.distinguishing}\n\n`;

  t += `═══ II. FAMILY BACKGROUND ═══\n`;
  t += `Father: ${C.dadFirst} ${C.lastName} — ${C.dadJob.job}\n`;
  t += `  Temperament: ${C.dadPersonality}\n`;
  t += `Mother: ${C.momFirst} ${C.momMaiden} ${C.lastName} — ${C.momJob.job}\n`;
  t += `  Temperament: ${C.momPersonality}\n`;
  t += `Siblings: ${C.siblings === 0 ? 'None (only child)' : C.siblings + ' — ' + C.birthOrder}\n`;
  t += `Social Class: ${C.familyClass}\n`;
  t += `Family Dynamic: ${C.parentRelationship}\n\n`;

  t += `═══ III. CHILDHOOD (Ages 1–12) ═══\n`;
  t += `${C.firstName} ${C.elementaryExperience}. As a kid, ${pronoun.toLowerCase()} spent most of ${possessive} free time ${C.childhoodHobby}. ${pronoun} ${C.childhoodDream}. ${possessive.charAt(0).toUpperCase() + possessive.slice(1)} deepest fear was ${C.childhoodFear}.\n`;
  t += `Childhood Traits: ${C.childhoodTraits.join(', ')}\n\n`;

  if (C.childhoodEvents.length > 0) {
    t += `Childhood Events:\n`;
    sortEvents(C.childhoodEvents).forEach(e => {
      const marker = e.type === 'positive' ? '[+]' : e.type === 'negative' ? '[-]' : '[·]';
      t += `  ${marker} ${e.year} (Age ${e.year - C.birthYear}): ${e.text}\n`;
    });
    t += `\n`;
  }

  t += `═══ IV. TEEN YEARS (Ages 13–17) ═══\n`;
  t += `School: ${C.highSchoolType}\n`;
  t += `Academics: ${C.teenAcademics}\n`;
  t += `Social Group: ${C.teenSocial}\n`;
  t += `Favorite Music: ${C.musicTaste}\n`;
  t += `Hobby: ${C.teenHobby}\n`;
  t += `First Love: ${C.firstLove}\n`;
  t += `Teen Traits: ${C.teenTraits.join(', ')}\n\n`;

  if (C.teenEvents.length > 0) {
    t += `Teen Events:\n`;
    sortEvents(C.teenEvents).forEach(e => {
      const marker = e.type === 'positive' ? '[+]' : e.type === 'negative' ? '[-]' : '[·]';
      t += `  ${marker} ${e.year} (Age ${e.year - C.birthYear}): ${e.text}\n`;
    });
    t += `\n`;
  }

  t += `═══ V. YOUNG ADULTHOOD ═══\n`;
  t += `Path: ${C.adultPathDesc}\n\n`;

  if (C.adultEvents.length > 0) {
    t += `Adult Events:\n`;
    sortEvents(C.adultEvents).forEach(e => {
      const marker = e.type === 'positive' ? '[+]' : e.type === 'negative' ? '[-]' : '[·]';
      t += `  ${marker} ${e.year} (Age ${e.year - C.birthYear}): ${e.text}\n`;
    });
    t += `\n`;
  }

  t += `═══ VI. CURRENT STATUS (${C.gameStartYear}) ═══\n`;
  t += `Age: ${C.gameStartAge}\n`;
  t += `Financial Status: ${C.financialStatus}\n`;
  t += `Living In: ${C.livingSituation}\n`;
  t += `Motivation: ${C.currentMotivation}\n`;
  t += `Deepest Fear: ${C.currentFear}\n\n`;

  t += `Personality Traits: ${C.currentTraits.join(', ')}\n`;
  t += `Skills: ${C.skills.join(', ')}\n`;
  t += `Habits & Quirks: ${C.habits.join('; ')}\n\n`;

  t += `Connections:\n`;
  C.connections.forEach(c => { t += `  • ${c}\n`; });
  t += `\nPrized Possession: ${C.prizedPossession}\n`;

  t += `\n═══ VII. MIDJOURNEY PORTRAIT PROMPT ═══\n`;
  t += `/imagine prompt: ${buildMidjourneyPrompt(C, currentPortraitStyle)}\n`;

  return t;
}

function buildRoll20HTML(C) {
  const sortEvents = (events) => [...events].sort((a, b) => a.year - b.year);
  const pronoun = C.gender === 'male' ? 'He' : 'She';
  const possessive = C.gender === 'male' ? 'his' : 'her';

  let h = '';
  h += `<h1>${C.fullName}</h1>\n`;
  h += `<p><em>${C.gender === 'male' ? 'Male' : 'Female'}, Age ${C.gameStartAge} (Born ${C.birthYear}) — ${C.ethnicity}</em></p>\n`;
  h += `<p><strong>Birthplace:</strong> ${C.birthCity.name} | <strong>Religion:</strong> ${C.religion}</p>\n`;
  h += `<hr>\n\n`;

  h += `<h2>Physical Description</h2>\n`;
  h += `<p>${C.height}, ${C.build} build. ${C.hair} hair, ${C.eyes} eyes. ${C.distinguishing.charAt(0).toUpperCase() + C.distinguishing.slice(1)}.</p>\n`;
  h += `<hr>\n\n`;

  h += `<h2>Family</h2>\n`;
  h += `<p><strong>Father:</strong> ${C.dadFirst} ${C.lastName} — ${C.dadJob.job}. ${C.dadPersonality.charAt(0).toUpperCase() + C.dadPersonality.slice(1)}.</p>\n`;
  h += `<p><strong>Mother:</strong> ${C.momFirst} ${C.momMaiden} ${C.lastName} — ${C.momJob.job}. ${C.momPersonality.charAt(0).toUpperCase() + C.momPersonality.slice(1)}.</p>\n`;
  h += `<p><strong>Siblings:</strong> ${C.siblings === 0 ? 'None (only child)' : C.siblings + ' — ' + C.birthOrder} | <strong>Class:</strong> ${C.familyClass}</p>\n`;
  h += `<p><strong>Family Dynamic:</strong> ${C.parentRelationship}.</p>\n`;
  h += `<hr>\n\n`;

  h += `<h2>Childhood</h2>\n`;
  h += `<p>${C.firstName} ${C.elementaryExperience}. As a kid, ${pronoun.toLowerCase()} spent most of ${possessive} free time ${C.childhoodHobby}. ${pronoun} ${C.childhoodDream}. ${possessive.charAt(0).toUpperCase() + possessive.slice(1)} deepest fear was ${C.childhoodFear}.</p>\n`;
  h += `<p><strong>Childhood Traits:</strong> <em>${C.childhoodTraits.join(', ')}</em></p>\n`;

  if (C.childhoodEvents.length > 0) {
    h += `<ul>\n`;
    sortEvents(C.childhoodEvents).forEach(e => {
      const color = e.type === 'positive' ? 'green' : e.type === 'negative' ? 'red' : 'gray';
      h += `  <li><strong style="color:${color}">${e.year} (Age ${e.year - C.birthYear}):</strong> ${e.text}</li>\n`;
    });
    h += `</ul>\n`;
  }
  h += `<hr>\n\n`;

  h += `<h2>Teen Years</h2>\n`;
  h += `<p><strong>School:</strong> ${C.highSchoolType} | <strong>Academics:</strong> ${C.teenAcademics}</p>\n`;
  h += `<p><strong>Social Group:</strong> ${C.teenSocial} | <strong>Music:</strong> ${C.musicTaste}</p>\n`;
  h += `<p><strong>First Love:</strong> ${C.firstLove}.</p>\n`;
  h += `<p><strong>Teen Traits:</strong> <em>${C.teenTraits.join(', ')}</em></p>\n`;

  if (C.teenEvents.length > 0) {
    h += `<ul>\n`;
    sortEvents(C.teenEvents).forEach(e => {
      const color = e.type === 'positive' ? 'green' : e.type === 'negative' ? 'red' : 'gray';
      h += `  <li><strong style="color:${color}">${e.year} (Age ${e.year - C.birthYear}):</strong> ${e.text}</li>\n`;
    });
    h += `</ul>\n`;
  }
  h += `<hr>\n\n`;

  h += `<h2>Young Adulthood</h2>\n`;
  h += `<p>${C.adultPathDesc}</p>\n`;

  if (C.adultEvents.length > 0) {
    h += `<ul>\n`;
    sortEvents(C.adultEvents).forEach(e => {
      const color = e.type === 'positive' ? 'green' : e.type === 'negative' ? 'red' : 'gray';
      h += `  <li><strong style="color:${color}">${e.year} (Age ${e.year - C.birthYear}):</strong> ${e.text}</li>\n`;
    });
    h += `</ul>\n`;
  }
  h += `<hr>\n\n`;

  h += `<h2>Current Status (${C.gameStartYear})</h2>\n`;
  h += `<table border="1" cellpadding="6" cellspacing="0">\n`;
  h += `  <tr><td><strong>Age</strong></td><td>${C.gameStartAge}</td><td><strong>Financial</strong></td><td>${C.financialStatus}</td></tr>\n`;
  h += `  <tr><td><strong>Living In</strong></td><td>${C.livingSituation}</td><td><strong>Motivation</strong></td><td>${C.currentMotivation}</td></tr>\n`;
  h += `</table>\n\n`;

  h += `<p><strong>Personality:</strong> <em>${C.currentTraits.join(', ')}</em></p>\n`;
  h += `<p><strong>Deepest Fear:</strong> ${C.currentFear}</p>\n`;
  h += `<p><strong>Skills:</strong> ${C.skills.join(', ')}</p>\n`;
  h += `<p><strong>Habits:</strong> ${C.habits.join('; ')}</p>\n\n`;

  h += `<h3>Connections</h3>\n<ul>\n`;
  C.connections.forEach(c => { h += `  <li>${c}</li>\n`; });
  h += `</ul>\n\n`;

  h += `<p><strong>Prized Possession:</strong> <em>${C.prizedPossession}</em></p>\n\n`;

  h += `<hr>\n<h3>Midjourney Portrait Prompt</h3>\n`;
  h += `<p><code>/imagine prompt: ${buildMidjourneyPrompt(C, currentPortraitStyle)}</code></p>\n`;

  return h;
}

function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function exportRoll20HTML() {
  if (!currentCharacter) return;
  const C = currentCharacter;
  const html = buildRoll20HTML(C);
  const filename = `${C.firstName}_${C.lastName}_Roll20.html`.replace(/\s+/g, '_');
  downloadFile(html, filename, 'text/html');
}

function exportPlainText() {
  if (!currentCharacter) return;
  const C = currentCharacter;
  const text = buildCharText(C);
  const filename = `${C.firstName}_${C.lastName}_LifePath.txt`.replace(/\s+/g, '_');
  downloadFile(text, filename, 'text/plain');
}

function exportJSON() {
  if (!currentCharacter) return;
  const C = currentCharacter;

  // Build a clean JSON export
  const sortEvents = (events) => [...events].sort((a, b) => a.year - b.year);
  const exportObj = {
    name: C.fullName,
    firstName: C.firstName,
    lastName: C.lastName,
    gender: C.gender,
    birthYear: C.birthYear,
    gameStartYear: C.gameStartYear,
    gameStartAge: C.gameStartAge,
    birthplace: C.birthCity.name,
    birthplaceType: C.birthCity.type,
    ethnicity: C.ethnicity,
    religion: C.religion,
    birthEvent: C.birthEvent,
    physical: {
      height: C.height,
      build: C.build,
      hair: C.hair,
      eyes: C.eyes,
      distinguishing: C.distinguishing
    },
    family: {
      father: { name: C.dadFirst + ' ' + C.lastName, job: C.dadJob.job, personality: C.dadPersonality },
      mother: { name: C.momFirst + ' ' + C.momMaiden + ' ' + C.lastName, job: C.momJob.job, maidenName: C.momMaiden, personality: C.momPersonality },
      siblings: C.siblings,
      birthOrder: C.birthOrder,
      socialClass: C.familyClass,
      relationship: C.parentRelationship
    },
    childhood: {
      schoolExperience: C.elementaryExperience,
      hobby: C.childhoodHobby,
      dream: C.childhoodDream,
      fear: C.childhoodFear,
      traits: C.childhoodTraits,
      events: sortEvents(C.childhoodEvents).map(e => ({ year: e.year, age: e.year - C.birthYear, text: e.text, type: e.type }))
    },
    teenYears: {
      school: C.highSchoolType,
      academics: C.teenAcademics,
      socialGroup: C.teenSocial,
      hobby: C.teenHobby,
      music: C.musicTaste,
      firstLove: C.firstLove,
      traits: C.teenTraits,
      events: sortEvents(C.teenEvents).map(e => ({ year: e.year, age: e.year - C.birthYear, text: e.text, type: e.type }))
    },
    adulthood: {
      path: C.adultPath,
      description: C.adultPathDesc,
      events: sortEvents(C.adultEvents).map(e => ({ year: e.year, age: e.year - C.birthYear, text: e.text, type: e.type }))
    },
    currentStatus: {
      financialStatus: C.financialStatus,
      livingSituation: C.livingSituation,
      motivation: C.currentMotivation,
      fear: C.currentFear,
      traits: C.currentTraits,
      skills: C.skills,
      habits: C.habits,
      connections: C.connections,
      prizedPossession: C.prizedPossession
    },
    midjourneyPrompt: '/imagine prompt: ' + buildMidjourneyPrompt(C, currentPortraitStyle)
  };

  const json = JSON.stringify(exportObj, null, 2);
  const filename = `${C.firstName}_${C.lastName}_LifePath.json`.replace(/\s+/g, '_');
  downloadFile(json, filename, 'application/json');
}

// Auto-generate on load
window.addEventListener('load', () => setTimeout(generate, 500));
</script>
</body>
</html>
